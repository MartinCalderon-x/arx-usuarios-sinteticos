# ============================================
# Usuarios Sintéticos - Cloud Run Deployment
# ============================================
# Estrategia de Deploy:
# - DEV: Automático en push a develop
# - PROD: Manual via workflow_dispatch
#
# Los tags (v*) son solo para versionado, NO disparan deploy automático a PROD
#
# Secrets requeridos:
# - GCP_PROJECT_ID
# - GCP_REPO_NAME
# - GCP_SERVICE_NAME
# - GCP_SA_KEY
# - GOOGLE_API_KEY
# - SUPABASE_URL
# - SUPABASE_ANON_KEY
# - SUPABASE_SERVICE_ROLE_KEY
# ============================================

name: Deploy to Cloud Run

on:
  push:
    branches: [develop]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod

env:
  REGION: us-central1

jobs:
  # ============================================
  # ML Service Deployment (DeepGaze)
  # ============================================
  deploy-ml-service:
    runs-on: ubuntu-latest

    outputs:
      url: ${{ steps.get-url.outputs.url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set environment
        id: env
        run: |
          if [[ "${{ github.event.inputs.environment }}" == "prod" ]]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
            echo "image_tag=ml-prod-$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
            echo "image_tag=ml-dev-$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT
          fi

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Build and Push ML Service
        working-directory: product/ml-service
        run: |
          IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.GCP_REPO_NAME }}/${{ secrets.GCP_SERVICE_NAME }}-ml:${{ steps.env.outputs.image_tag }}"
          docker build -t $IMAGE -f Dockerfile .
          docker push $IMAGE
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV

      - name: Deploy ML Service to Cloud Run (DEV)
        if: steps.env.outputs.environment == 'dev'
        run: |
          gcloud run deploy ${{ secrets.GCP_SERVICE_NAME }}-ml-dev \
            --image ${{ env.IMAGE }} \
            --region ${{ env.REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --memory 4Gi \
            --cpu 2 \
            --timeout 300 \
            --concurrency 10 \
            --max-instances 2 \
            --set-env-vars "ML_DEEPGAZE_MODEL=deepgaze3" \
            --set-env-vars "ML_DEVICE=cpu" \
            --set-env-vars "ML_MAX_IMAGE_SIZE=1024"

      - name: Deploy ML Service to Cloud Run (PROD)
        if: steps.env.outputs.environment == 'prod'
        run: |
          gcloud run deploy ${{ secrets.GCP_SERVICE_NAME }}-ml \
            --image ${{ env.IMAGE }} \
            --region ${{ env.REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --memory 4Gi \
            --cpu 2 \
            --timeout 300 \
            --concurrency 10 \
            --min-instances 1 \
            --max-instances 5 \
            --set-env-vars "ML_DEEPGAZE_MODEL=deepgaze3" \
            --set-env-vars "ML_DEVICE=cpu" \
            --set-env-vars "ML_MAX_IMAGE_SIZE=1024"

      - name: Get ML Service URL
        id: get-url
        run: |
          SERVICE_NAME="${{ secrets.GCP_SERVICE_NAME }}-ml"
          if [[ "${{ steps.env.outputs.environment }}" == "dev" ]]; then
            SERVICE_NAME="${SERVICE_NAME}-dev"
          fi
          URL=$(gcloud run services describe $SERVICE_NAME --region ${{ env.REGION }} --format 'value(status.url)')
          echo "url=$URL" >> $GITHUB_OUTPUT

  # ============================================
  # Backend Deployment
  # ============================================
  deploy-backend:
    runs-on: ubuntu-latest
    needs: deploy-ml-service

    outputs:
      url: ${{ steps.get-url.outputs.url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set environment
        id: env
        run: |
          if [[ "${{ github.event.inputs.environment }}" == "prod" ]]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
            LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
            if [[ -n "$LATEST_TAG" ]]; then
              echo "image_tag=${LATEST_TAG}" >> $GITHUB_OUTPUT
            else
              echo "image_tag=prod-$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT
            fi
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
            echo "image_tag=dev-$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT
          fi

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Get ML Service URL
        id: ml-url
        run: |
          SERVICE_NAME="${{ secrets.GCP_SERVICE_NAME }}-ml"
          if [[ "${{ steps.env.outputs.environment }}" == "dev" ]]; then
            SERVICE_NAME="${SERVICE_NAME}-dev"
          fi
          URL=$(gcloud run services describe $SERVICE_NAME --region ${{ env.REGION }} --format 'value(status.url)')
          echo "ML_SERVICE_URL=$URL" >> $GITHUB_ENV

      - name: Build and Push Backend
        run: |
          IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.GCP_REPO_NAME }}/${{ secrets.GCP_SERVICE_NAME }}:${{ steps.env.outputs.image_tag }}"
          docker build -t $IMAGE -f Dockerfile .
          docker push $IMAGE
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV

      - name: Deploy Backend to Cloud Run (DEV)
        if: steps.env.outputs.environment == 'dev'
        run: |
          gcloud run deploy ${{ secrets.GCP_SERVICE_NAME }}-dev \
            --image ${{ env.IMAGE }} \
            --region ${{ env.REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --memory 512Mi \
            --cpu 1 \
            --max-instances 3 \
            --set-env-vars "GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY }}" \
            --set-env-vars "GEMINI_MODEL=gemini-2.0-flash" \
            --set-env-vars "GEMINI_VISION_MODEL=gemini-2.0-flash" \
            --set-env-vars "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" \
            --set-env-vars "SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}" \
            --set-env-vars "SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            --set-env-vars "API_HOST=0.0.0.0" \
            --set-env-vars "API_PORT=8080" \
            --set-env-vars "CORS_ORIGINS=*" \
            --set-env-vars "ML_SERVICE_URL=${{ env.ML_SERVICE_URL }}" \
            --set-env-vars "ML_SERVICE_ENABLED=true" \
            --set-env-vars "ML_SERVICE_TIMEOUT=120"

      - name: Deploy Backend to Cloud Run (PROD)
        if: steps.env.outputs.environment == 'prod'
        run: |
          gcloud run deploy ${{ secrets.GCP_SERVICE_NAME }} \
            --image ${{ env.IMAGE }} \
            --region ${{ env.REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --memory 1Gi \
            --cpu 2 \
            --min-instances 1 \
            --max-instances 10 \
            --set-env-vars "GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY }}" \
            --set-env-vars "GEMINI_MODEL=gemini-2.0-flash" \
            --set-env-vars "GEMINI_VISION_MODEL=gemini-2.0-flash" \
            --set-env-vars "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" \
            --set-env-vars "SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}" \
            --set-env-vars "SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            --set-env-vars "API_HOST=0.0.0.0" \
            --set-env-vars "API_PORT=8080" \
            --set-env-vars "CORS_ORIGINS=*" \
            --set-env-vars "ML_SERVICE_URL=${{ env.ML_SERVICE_URL }}" \
            --set-env-vars "ML_SERVICE_ENABLED=true" \
            --set-env-vars "ML_SERVICE_TIMEOUT=120"

      - name: Get Backend URL
        id: get-url
        run: |
          SERVICE_NAME="${{ secrets.GCP_SERVICE_NAME }}"
          if [[ "${{ steps.env.outputs.environment }}" == "dev" ]]; then
            SERVICE_NAME="${SERVICE_NAME}-dev"
          fi
          URL=$(gcloud run services describe $SERVICE_NAME --region ${{ env.REGION }} --format 'value(status.url)')
          echo "url=$URL" >> $GITHUB_OUTPUT

  # ============================================
  # Frontend Deployment
  # ============================================
  deploy-frontend:
    runs-on: ubuntu-latest
    needs: [deploy-ml-service, deploy-backend]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set environment
        id: env
        run: |
          if [[ "${{ github.event.inputs.environment }}" == "prod" ]]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
            echo "image_tag=frontend-prod-$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
            echo "image_tag=frontend-dev-$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT
          fi

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Get Backend URL
        id: backend-url
        run: |
          SERVICE_NAME="${{ secrets.GCP_SERVICE_NAME }}"
          if [[ "${{ steps.env.outputs.environment }}" == "dev" ]]; then
            SERVICE_NAME="${SERVICE_NAME}-dev"
          fi
          URL=$(gcloud run services describe $SERVICE_NAME --region ${{ env.REGION }} --format 'value(status.url)')
          echo "BACKEND_URL=$URL" >> $GITHUB_ENV

      - name: Build and Push Frontend
        working-directory: product/frontend
        run: |
          IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.GCP_REPO_NAME }}/${{ secrets.GCP_SERVICE_NAME }}-frontend:${{ steps.env.outputs.image_tag }}"
          docker build -t $IMAGE \
            --build-arg VITE_SUPABASE_URL=${{ secrets.SUPABASE_URL }} \
            --build-arg VITE_SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }} \
            --build-arg VITE_API_URL=${{ env.BACKEND_URL }} \
            -f Dockerfile .
          docker push $IMAGE
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV

      - name: Deploy Frontend to Cloud Run (DEV)
        if: steps.env.outputs.environment == 'dev'
        run: |
          gcloud run deploy ${{ secrets.GCP_SERVICE_NAME }}-frontend-dev \
            --image ${{ env.IMAGE }} \
            --region ${{ env.REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --memory 256Mi \
            --cpu 1 \
            --max-instances 3

      - name: Deploy Frontend to Cloud Run (PROD)
        if: steps.env.outputs.environment == 'prod'
        run: |
          gcloud run deploy ${{ secrets.GCP_SERVICE_NAME }}-frontend \
            --image ${{ env.IMAGE }} \
            --region ${{ env.REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --memory 256Mi \
            --cpu 1 \
            --min-instances 1 \
            --max-instances 5

      - name: Output URLs
        run: |
          SERVICE_NAME="${{ secrets.GCP_SERVICE_NAME }}"
          if [[ "${{ steps.env.outputs.environment }}" == "dev" ]]; then
            FRONTEND_SERVICE="${SERVICE_NAME}-frontend-dev"
            BACKEND_SERVICE="${SERVICE_NAME}-dev"
            ML_SERVICE="${SERVICE_NAME}-ml-dev"
          else
            FRONTEND_SERVICE="${SERVICE_NAME}-frontend"
            BACKEND_SERVICE="${SERVICE_NAME}"
            ML_SERVICE="${SERVICE_NAME}-ml"
          fi
          FRONTEND_URL=$(gcloud run services describe $FRONTEND_SERVICE --region ${{ env.REGION }} --format 'value(status.url)')
          BACKEND_URL=$(gcloud run services describe $BACKEND_SERVICE --region ${{ env.REGION }} --format 'value(status.url)')
          ML_URL=$(gcloud run services describe $ML_SERVICE --region ${{ env.REGION }} --format 'value(status.url)')
          echo "## Deployment Complete! :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ steps.env.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### URLs" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend:** $FRONTEND_URL" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend:** $BACKEND_URL" >> $GITHUB_STEP_SUMMARY
          echo "- **ML Service:** $ML_URL" >> $GITHUB_STEP_SUMMARY
